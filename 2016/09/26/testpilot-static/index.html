<!DOCTYPE html>
  <html lang="en-us">
    <head>
      <title>Firefox Test Pilot: The Flattening - blog.lmorchard.com</title>
      <meta property="og:type" content="article" />
      <meta property="og:site_name" content="blog.lmorchard.com" />
      <meta http-equiv="content-type" content="text/html; charset=utf-8" />
      <meta name="author" content="Les Orchard" />
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"
      />
      <link
            rel="stylesheet"
            href="/blog.lmorchard.com/css/screen.css"
            type="text/css"
            media="screen, projection"
          /><link
            rel="stylesheet"
            href="/blog.lmorchard.com/css/vendor/font-awesome.css"
            type="text/css"
            media="screen, projection"
          /><link
            rel="stylesheet"
            href="/blog.lmorchard.com/css/vendor/prism.css"
            type="text/css"
            media="screen, projection"
          />
      <link
              href="/blog.lmorchard.com/index.rss"
              rel="alternate"
              title="blog.lmorchard.com"
              type="application/rss+xml"
            />
      <meta property="og:title" content="Firefox Test Pilot: The Flattening" />
        <meta
          property="og:url"
          content="https://lmorchard.github.io/blog.lmorchard.com//"
        />
        <meta
            property="og:image"
            content="https://lmorchard.github.io/blog.lmorchard.com//blog.lmorchard.com/uploads/2016/tp-flat.png"
          />
        <meta property="og:description" content="&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;: Firefox Test Pilot is becoming a statically-generated site from content in flat files. We&amp;apos;re moving away from Django and PostgreSQL, and it&amp;apos;s been a bit of a journey.&lt;/p&gt;
" />
    </head>
    <body>
      <section class="main">
        <header>
          <h1><a href="/blog.lmorchard.com/">blog.lmorchard.com</a></h1>
          <h2>It&#39;s all spinning wheels and self-doubt until the first pot of coffee.</h2>
          <nav>
            <label for="nav-trigger"></label>
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />

            <ul>
              <li><a href="http://lmorchard.com/">about me</a></li>
              <li><a href="/blog.lmorchard.com/archives.html">archives</a></li>
            </ul>
          </nav>
        </header>

        <section class="content">
          <article
        class="post tag-mozillatag-testpilottag-webdevtag-djangotag-gulp"
      >
        <time
          title="2016-09-26T12:00:00+00:00"
          pubdate="2016-09-26T12:00:00+00:00"
        >
          <a href="/blog.lmorchard.com/"><i class="fa fa-home"></i></a>
          &raquo;
          <a href="/blog.lmorchard.com/2016/"
            >2016</a
          >
          &raquo;
          <a href="/blog.lmorchard.com/2016/09/"
            >September</a
          >
          &raquo;
          <span>26</span>
          &raquo;
        </time>
        <h1 class="title">Firefox Test Pilot: The Flattening</h1>
        <ul class="tags">
            <li>
                  <a href="/blog.lmorchard.com/tag/mozilla/">mozilla</a>
                </li><li>
                  <a href="/blog.lmorchard.com/tag/testpilot/">testpilot</a>
                </li><li>
                  <a href="/blog.lmorchard.com/tag/webdev/">webdev</a>
                </li><li>
                  <a href="/blog.lmorchard.com/tag/django/">django</a>
                </li><li>
                  <a href="/blog.lmorchard.com/tag/gulp/">gulp</a>
                </li>
          </ul>
        <section class="post-content">
          <p><strong>TL;DR</strong>: Firefox Test Pilot is becoming a statically-generated site from content in flat files. We&#39;re moving away from Django and PostgreSQL, and it&#39;s been a bit of a journey.</p>
<!--more-->

<img class="fullwidth" src="/uploads/2016/tp-header.png" />

<nav role="navigation" class="table-of-contents"></nav>

<p>I&#39;ve been working on <a href="https://testpilot.firefox.com/">Firefox Test Pilot</a> for over a year, but I haven&#39;t written about it here before now. Mostly because I&#39;ve been busy and lazy and <a href="/2016/08/31/yak-shaving-habits/">busily shaving yaks</a>.</p>
<p>But, there have been big things afoot lately, and I figured they were worth writing about - if only because they&#39;re invisible, behind-the-scenes things that nonetheless took a lot of work to accomplish.</p>
<h2 id="be-prepared---but-for-what">Be prepared - but for what?</h2>
<p>When we started building Test Pilot last summer, we based the server-side on Django &amp; PostgreSQL. We had assumptions about the future: </p>
<ul>
<li><p>We&#39;d need to collect measurements from experiments. </p>
</li>
<li><p>We thought experiments would need some active server-side resources provided by the mothership.</p>
</li>
<li><p>We&#39;d need to manage user profiles &amp; preferences, so we required sign-in with a Firefox Account. </p>
</li>
</ul>
<p>A year later, these assumptions didn&#39;t quite pan out: </p>
<ul>
<li><p>Rather than reinvent the wheel by collecting &amp; analyzing measurements ourselves, we took advantage of Google Analytics and the efforts of <a href="https://wiki.mozilla.org/Telemetry">the Firefox Telemetry team</a>.</p>
</li>
<li><p>We found it&#39;s best to stay out of the way of teams building Test Pilot experiments - let them manage their own services as necessary, rather than be tied to the delivery cadence of the core project.</p>
</li>
<li><p>The sign-in requirement turned away many potential users. But, we didn&#39;t need accounts to facilitate experiment participation anyway. Our metrics are anonymous and a Firefox add-on manages opt-in.</p>
<p>Accounts ended up being private data we had to keep secure, but only used for email notifications. We have better ways to manage email subscriptions across Mozilla - so one less wheel to reinvent!</p>
</li>
</ul>
<h2 id="didnt-need-that-server-anyway">Didn&#39;t need that server anyway</h2>
<p>There was just one last reason to use Django &amp; PostgreSQL on Test Pilot: A web-based content management system to update the site without heavyweight server deployments &amp; database migrations. </p>
<p>But, wait a minute: If the other reasons for a server dropped away - why do we need complex deployments?</p>
<p>Furthermore, why maintain content <a href="https://indieweb.org/database-antipattern">in a database</a> at all?</p>
<p>The whole Test Pilot team knows their way around text editors and GitHub - so let&#39;s make that our CMS. We can <a href="https://github.com/mozilla/testpilot/blob/master/frontend/tasks/pages.js">bake the whole site</a> from <a href="https://github.com/mozilla/testpilot/tree/master/content-src/experiments">flat files</a>. Deployment is <a href="https://github.com/mozilla/testpilot/blob/master/docs/development/deployment.md#producing-a-static-build">running a build script</a> and <a href="https://github.com/mozilla/testpilot/blob/master/circle.yml#L71">uploading the result</a> to a web server. We get revision control &amp; collaboration along with the rest of the project. And as a security bonus, we stop shipping the tools to change the site along with the deployed site itself.</p>
<p>None of this is revolutionary. Aaron Swartz&#39;s &quot;<a href="http://www.aaronsw.com/weblog/000404">Bake, Don&#39;t Fry</a>&quot; is over 14 years old: Why fry up a new web page for every visit when you can pre-bake the whole site ahead of time? I used <a href="http://blosxom.sourceforge.net/">Bloxsom</a> back in the day and <a href="https://blog.lmorchard.com/2014/10/20/static-blog-generation-with-gulp/">Gulp bakes this blog now</a>. Static site generators <a href="https://www.staticgen.com/">are numerous &amp; popular</a> - GitHub itself offers <a href="https://help.github.com/articles/using-jekyll-as-a-static-site-generator-with-github-pages/">GitHub Pages</a> powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a>.</p>
<p>It sounds obvious in retrospect, but it took awhile to realize our site could be stripped down to so little. We assumed we needed all those moving parts - or would need them someday. But, it appears that we can get away with being nearly serverless. And if someday a feature requires more, we can stand up some loosely-coupled microservices - or better yet, find that another team at Mozilla has already solved the problem.</p>
<h2 id="the-show-must-go-on">The show must go on</h2>
<p>But, having realized all of this, we couldn&#39;t just burn down the site and start over. Because we&#39;re working on a vehicle in motion, we&#39;ve been doing this in increments over the summer: </p>
<ul>
<li><p>A couple of months ago, <a href="https://github.com/mozilla/testpilot/issues/1035">we removed the Firefox Accounts requirement</a> and then <a href="https://github.com/mozilla/testpilot/issues/1034">deleted the user data</a> once we were sure we weren&#39;t going back.</p>
</li>
<li><p>We switched data sources for displaying the number of folks participating in experiments from our own Django API to <a href="https://github.com/mozilla/testpilot/issues/1039">a Telemetry-based resource</a>.</p>
</li>
<li><p>I wrote a task to <a href="https://github.com/mozilla/testpilot/blob/master/frontend/tasks/content.js#L22">import content from the current Django API</a>. Then, I wrote <a href="https://github.com/mozilla/testpilot/blob/master/frontend/tasks/content.js#L16">a task to generate JSON</a> from those imported files - a direct static replacement for the Django API.</p>
</li>
<li><p>Next, I implemented <a href="https://github.com/mozilla/testpilot/blob/master/testpilot/experiments/views.py#L50">a feature flag in Django</a> to substitute static JSON for content from the database. Thus, we can start managing content in YAML now, maintaining our current infrastructure until we work out a new stripped-down deployment process.</p>
</li>
<li><p>Soon, we&#39;ll be able to update the site by pushing to the appropriate branch on GitHub. We&#39;ve got <a href="https://github.com/mozilla/testpilot/blob/master/frontend/tasks/pages.js">tasks to generate stub pages</a> for all the front end app routes. We&#39;re also looking into enforcing a requirement to <a href="http://micropipes.com/blog//2016/08/31/signing-your-commits-on-github-with-a-gpg-key/">sign our commits and tags</a> on the way to release.</p>
</li>
<li><p>After that, <a href="https://github.com/mozilla/testpilot/issues/1306">we plan to go even further with static site generation</a>. Test Pilot is currently a single page app that pulls content from JSON. But, we can do better by pre-rendering those HTML pages in our build process ahead of time.</p>
</li>
</ul>
<h2 id="whats-next">What&#39;s next?</h2>
<p>There&#39;s a funny thing about all of this: If we&#39;re successful, no one visiting the site should notice anything different. We&#39;re developing some new features &amp; experiments - but all this work to rid our infrastructure of Django &amp; PostgreSQL should ideally be a non-event for anyone visiting the site. This is the least glamorous sort of work one occasionally has to do on a software project - change everything, but don&#39;t break anything.</p>
<p>The real benefit will be that we&#39;re able to do a lot of things faster and more easily. For instance, there are now fewer places that need changes to display a new piece of information on a page. We don&#39;t have to monitor as many third-party dependencies - <a href="https://github.com/mozilla/testpilot/issues/1116">which we weren&#39;t doing very well to begin with</a>.</p>
<p>Our development stack shrinks from Docker containers with Django &amp; PostgreSQL &amp; Node.js - down to just Node.js v6.2.0. <a href="https://github.com/mozilla/testpilot/blob/master/docs/development/quickstart.md">The whole system has gotten simpler and more direct</a>.</p>
<p>But, wait, there&#39;s more: Along with totally changing our server-side infrastructure, <a href="https://github.com/mozilla/testpilot/issues/1307">we&#39;ve also rewritten the front end of the site to switch from Ampersand to React &amp; Redux</a>. It should make static site generation easier. It&#39;s also eased development on a handful of new features in the past week or so.</p>
<p>It&#39;s a big deal - and another thing that, in retrospect, seems more obvious now than it did a year ago. But, I&#39;m going to save writing about that for my next post.</p>
<!-- vim: set wrap linebreak nolist wrapmargin=0 textwidth=0 syntax=markdown formatoptions-=t: -->

        </section>
      </article>

      <section class="comments" id="comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
            var disqus_needs_loading = true;
            var disqus_url = "https://lmorchard.github.io/blog.lmorchard.com/";
          </script>
          <noscript
            >Please enable JavaScript to view the
            <a href="http://disqus.com/?ref_noscript"
              >comments powered by Disqus.</a
            ></noscript
          >
          <a href="http://disqus.com" class="dsq-brlink"
            >blog comments powered by <span class="logo-disqus">Disqus</span></a
          >
        </section>
        </section>

        <footer>
          <img id="growup" src="/blog.lmorchard.com/uploads/growup.jpg" />
        </footer>
      </section>

      <section id="javascript">
        <script src="/blog.lmorchard.com/js/vendor/lazyload.js"></script><script src="/blog.lmorchard.com/js/vendor/prism.js"></script><script src="/blog.lmorchard.com/js/toc.js"></script><script src="/blog.lmorchard.com/js/analytics.js"></script><script src="/blog.lmorchard.com/js/main.js"></script>
        
      </section>
    </body>
  </html>