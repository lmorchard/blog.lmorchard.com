<!DOCTYPE html>
    <html>
      <head>
        <title>Firefox Test Pilot: The Flattening - blog.lmorchard.com</title>
        <meta property="og:type" content="article" />
        <meta property="og:site_name" content="blog.lmorchard.com" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="Les Orchard" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"
        />
        <link
          rel="shortcut icon"
          href="https://www.gravatar.com/avatar/b45c48fc9e05922e2f368a9d7d7d8de1?s=16"
        />

        <script
          defer
          data-domain="blog.lmorchard.com"
          src="https://analytics.lmorchard.com/js/plausible.js"
        ></script>

        <link
          rel="stylesheet"
          type="text/css"
          href="/blog.lmorchard.com/index.css"
        />
        <script type="module" src="/blog.lmorchard.com/index.js"></script>

        <link
          href="https://lmorchard.github.io/blog.lmorchard.com/index.rss"
          rel="alternate"
          title="blog.lmorchard.com"
          type="application/rss+xml"
        />

        <link
                href="/blog.lmorchard.com/index.rss"
                rel="alternate"
                title="blog.lmorchard.com"
                type="application/rss+xml"
              />
        <meta property="og:title" content="Firefox Test Pilot: The Flattening" />
        <meta
          property="og:url"
          content="https://lmorchard.github.io/blog.lmorchard.com/2016/09/26/testpilot-static/"
        />
        <meta
            property="og:image"
            content="https://lmorchard.github.io/blog.lmorchard.com/blog.lmorchard.com/uploads/2016/tp-flat.png"
          />
        <meta property="og:description" content="TL;DR: Firefox Test Pilot is becoming a statically-generated site from content in flat files. We&#39;re moving away from Django and PostgreSQL, and it&#39;s been a bit of a journey." />
      </head>
      <body>
        <header class="content-grid">
          <div class="masthead">
            <img src="https://www.gravatar.com/avatar/b45c48fc9e05922e2f368a9d7d7d8de1.jpg?s=128" />
            <div class="title">
              <h1>
                <a href="/blog.lmorchard.com/" title="blog.lmorchard.com">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="100%"
                    height="100%"
                    viewBox="0 0 250 20"
                  >
                    <text
                      lengthAdjust="spacing"
                      fill="currentColor"
                      y="16"
                      textLength="240"
                      x="5"
                    >
                      blog.lmorchard.com
                    </text>
                  </svg>
                </a>
              </h1>
              <h2>
                <rotating-tagline
                  random
                  initial="1"
                  period="7000"
                  src="/blog.lmorchard.com/taglines.json"
                >
                  <a href="/blog.lmorchard.com/" title="It&#39;s all spinning wheels &amp; self-doubt until the first pot of coffee.">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="100%"
                      height="100%"
                      viewBox="0 0 250 20"
                    >
                      <text
                        class="tagline"
                        lengthAdjust="spacing"
                        fill="currentColor"
                        y="16"
                        textLength="240"
                        x="5"
                      >
                        It&#39;s all spinning wheels &amp; self-doubt until the first pot of coffee.
                      </text>
                    </svg>
                  </a>
                </rotating-tagline>
              </h2>
            </div>
          </div>
          <nav class="main-nav">
            <div id="search"></div>
            <ul>
              <li>
                <a href="http://lmorchard.com/"
                  ><span class="fa fa-info-circle"></span> about me</a
                >
              </li>
              <li>
                <a href="/blog.lmorchard.com/archives.html"
                  ><span class="fa fa-archive"></span> archives</a
                >
              </li>
              <li>
                <a href="https://lmorchard.github.io/blog.lmorchard.com/index.rss" title="blog.lmorchard.com"
                  ><span class="fa fa-rss"></span> feed</a
                >
              </li>
              <li class="theme-selector">
                <theme-selector title="Enable dark theme">
                  <label>
                    <input type="checkbox" />
                    <span class="slider"></span>
                  </label>
                </theme-selector>
              </li>
            </ul>
          </nav>
        </header>

        <section class="main"><article
        data-pagefind-body
        class="content content-grid post tag-mozillatag-testpilottag-webdevtag-djangotag-gulp"
      >
        <header>
          <time
            title="2016-09-26T12:00:00-07:00"
            pubdate="2016-09-26T12:00:00-07:00"
          >
            <span class="prevpost">
              <a
                title="Heartbroken"
                href="/blog.lmorchard.com/2016/11/11/heartbroken/"
                >&nbsp;<span class="fa fa-long-arrow-left"></span>&nbsp;</a
              >
            </span>
            <span class="postdate">
              <a href="/blog.lmorchard.com/2016/"
                >2016</a
              >
              &#8226;
              <a href="/blog.lmorchard.com/2016/09/"
                >September</a
              >
              &#8226;
              <span>26</span>
            </span>
            <span class="nextpost">
              <a
                title="Poking the Mongo on Pico-8"
                href="/blog.lmorchard.com/2016/09/11/poke-the-mongo/"
                >&nbsp;<span class="fa fa-long-arrow-right"></span>&nbsp;</a
              >
            </span>
          </time>
          <h1 class="title">Firefox Test Pilot: The Flattening</h1>
          <ul class="tags">
              <li><a href="/blog.lmorchard.com/tag/mozilla/">mozilla</a></li><li><a href="/blog.lmorchard.com/tag/testpilot/">testpilot</a></li><li><a href="/blog.lmorchard.com/tag/webdev/">webdev</a></li><li><a href="/blog.lmorchard.com/tag/django/">django</a></li><li><a href="/blog.lmorchard.com/tag/gulp/">gulp</a></li>
            </ul>
        </header>

        <p><strong>TL;DR</strong>: Firefox Test Pilot is becoming a statically-generated site from content in flat files. We're moving away from Django and PostgreSQL, and it's been a bit of a journey.</p>
<!--more-->



<img class="fullwidth" src="/uploads/2016/tp-header.png" width="" height="">

<nav role="navigation" class="table-of-contents"></nav>

<p>I've been working on <a href="https://testpilot.firefox.com/">Firefox Test Pilot</a> for over a year, but I haven't written about it here before now. Mostly because I've been busy and lazy and <a href="/2016/08/31/yak-shaving-habits/">busily shaving yaks</a>.</p>
<p>But, there have been big things afoot lately, and I figured they were worth writing about - if only because they're invisible, behind-the-scenes things that nonetheless took a lot of work to accomplish.</p>
<h2 id="be-prepared---but-for-what">Be prepared - but for what?</h2>
<p>When we started building Test Pilot last summer, we based the server-side on Django &amp; PostgreSQL. We had assumptions about the future: </p>
<ul>
<li><p>We'd need to collect measurements from experiments. </p>
</li>
<li><p>We thought experiments would need some active server-side resources provided by the mothership.</p>
</li>
<li><p>We'd need to manage user profiles &amp; preferences, so we required sign-in with a Firefox Account.</p>
</li>
</ul>
<p>A year later, these assumptions didn't quite pan out: </p>
<ul>
<li><p>Rather than reinvent the wheel by collecting &amp; analyzing measurements ourselves, we took advantage of Google Analytics and the efforts of <a href="https://wiki.mozilla.org/Telemetry">the Firefox Telemetry team</a>.</p>
</li>
<li><p>We found it's best to stay out of the way of teams building Test Pilot experiments - let them manage their own services as necessary, rather than be tied to the delivery cadence of the core project.</p>
</li>
<li><p>The sign-in requirement turned away many potential users. But, we didn't need accounts to facilitate experiment participation anyway. Our metrics are anonymous and a Firefox add-on manages opt-in.</p>
<p>Accounts ended up being private data we had to keep secure, but only used for email notifications. We have better ways to manage email subscriptions across Mozilla - so one less wheel to reinvent!</p>
</li>
</ul>
<h2 id="didnt-need-that-server-anyway">Didn't need that server anyway</h2>
<p>There was just one last reason to use Django &amp; PostgreSQL on Test Pilot: A web-based content management system to update the site without heavyweight server deployments &amp; database migrations. </p>
<p>But, wait a minute: If the other reasons for a server dropped away - why do we need complex deployments?</p>
<p>Furthermore, why maintain content <a href="https://indieweb.org/database-antipattern">in a database</a> at all?</p>
<p>The whole Test Pilot team knows their way around text editors and GitHub - so let's make that our CMS. We can <a href="https://github.com/mozilla/testpilot/blob/master/frontend/tasks/pages.js">bake the whole site</a> from <a href="https://github.com/mozilla/testpilot/tree/master/content-src/experiments">flat files</a>. Deployment is <a href="https://github.com/mozilla/testpilot/blob/master/docs/development/deployment.md#producing-a-static-build">running a build script</a> and <a href="https://github.com/mozilla/testpilot/blob/master/circle.yml#L71">uploading the result</a> to a web server. We get revision control &amp; collaboration along with the rest of the project. And as a security bonus, we stop shipping the tools to change the site along with the deployed site itself.</p>
<p>None of this is revolutionary. Aaron Swartz's "<a href="http://www.aaronsw.com/weblog/000404">Bake, Don't Fry</a>" is over 14 years old: Why fry up a new web page for every visit when you can pre-bake the whole site ahead of time? I used <a href="http://blosxom.sourceforge.net/">Bloxsom</a> back in the day and <a href="https://blog.lmorchard.com/2014/10/20/static-blog-generation-with-gulp/">Gulp bakes this blog now</a>. Static site generators <a href="https://www.staticgen.com/">are numerous &amp; popular</a> - GitHub itself offers <a href="https://help.github.com/articles/using-jekyll-as-a-static-site-generator-with-github-pages/">GitHub Pages</a> powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a>.</p>
<p>It sounds obvious in retrospect, but it took awhile to realize our site could be stripped down to so little. We assumed we needed all those moving parts - or would need them someday. But, it appears that we can get away with being nearly serverless. And if someday a feature requires more, we can stand up some loosely-coupled microservices - or better yet, find that another team at Mozilla has already solved the problem.</p>
<h2 id="the-show-must-go-on">The show must go on</h2>
<p>But, having realized all of this, we couldn't just burn down the site and start over. Because we're working on a vehicle in motion, we've been doing this in increments over the summer: </p>
<ul>
<li><p>A couple of months ago, <a href="https://github.com/mozilla/testpilot/issues/1035">we removed the Firefox Accounts requirement</a> and then <a href="https://github.com/mozilla/testpilot/issues/1034">deleted the user data</a> once we were sure we weren't going back.</p>
</li>
<li><p>We switched data sources for displaying the number of folks participating in experiments from our own Django API to <a href="https://github.com/mozilla/testpilot/issues/1039">a Telemetry-based resource</a>.</p>
</li>
<li><p>I wrote a task to <a href="https://github.com/mozilla/testpilot/blob/master/frontend/tasks/content.js#L22">import content from the current Django API</a>. Then, I wrote <a href="https://github.com/mozilla/testpilot/blob/master/frontend/tasks/content.js#L16">a task to generate JSON</a> from those imported files - a direct static replacement for the Django API.</p>
</li>
<li><p>Next, I implemented <a href="https://github.com/mozilla/testpilot/blob/master/testpilot/experiments/views.py#L50">a feature flag in Django</a> to substitute static JSON for content from the database. Thus, we can start managing content in YAML now, maintaining our current infrastructure until we work out a new stripped-down deployment process.</p>
</li>
<li><p>Soon, we'll be able to update the site by pushing to the appropriate branch on GitHub. We've got <a href="https://github.com/mozilla/testpilot/blob/master/frontend/tasks/pages.js">tasks to generate stub pages</a> for all the front end app routes. We're also looking into enforcing a requirement to <a href="http://micropipes.com/blog//2016/08/31/signing-your-commits-on-github-with-a-gpg-key/">sign our commits and tags</a> on the way to release.</p>
</li>
<li><p>After that, <a href="https://github.com/mozilla/testpilot/issues/1306">we plan to go even further with static site generation</a>. Test Pilot is currently a single page app that pulls content from JSON. But, we can do better by pre-rendering those HTML pages in our build process ahead of time.</p>
</li>
</ul>
<h2 id="whats-next">What's next?</h2>
<p>There's a funny thing about all of this: If we're successful, no one visiting the site should notice anything different. We're developing some new features &amp; experiments - but all this work to rid our infrastructure of Django &amp; PostgreSQL should ideally be a non-event for anyone visiting the site. This is the least glamorous sort of work one occasionally has to do on a software project - change everything, but don't break anything.</p>
<p>The real benefit will be that we're able to do a lot of things faster and more easily. For instance, there are now fewer places that need changes to display a new piece of information on a page. We don't have to monitor as many third-party dependencies - <a href="https://github.com/mozilla/testpilot/issues/1116">which we weren't doing very well to begin with</a>.</p>
<p>Our development stack shrinks from Docker containers with Django &amp; PostgreSQL &amp; Node.js - down to just Node.js v6.2.0. <a href="https://github.com/mozilla/testpilot/blob/master/docs/development/quickstart.md">The whole system has gotten simpler and more direct</a>.</p>
<p>But, wait, there's more: Along with totally changing our server-side infrastructure, <a href="https://github.com/mozilla/testpilot/issues/1307">we've also rewritten the front end of the site to switch from Ampersand to React &amp; Redux</a>. It should make static site generation easier. It's also eased development on a handful of new features in the past week or so.</p>
<p>It's a big deal - and another thing that, in retrospect, seems more obvious now than it did a year ago. But, I'm going to save writing about that for my next post.</p>
<!-- vim: set wrap linebreak nolist wrapmargin=0 textwidth=0 syntax=markdown formatoptions-=t: -->

        <section class="comments" id="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
              var disqus_needs_loading = true;
              var disqus_url = "https://lmorchard.github.io/blog.lmorchard.com/2016/09/26/testpilot-static/";
            </script>
            <noscript
              >Please enable JavaScript to view the
              <a href="http://disqus.com/?ref_noscript"
                >comments powered by Disqus.</a
              ></noscript
            >
            <a href="http://disqus.com" class="dsq-brlink"
              >blog comments powered by
              <span class="logo-disqus">Disqus</span></a
            >
          </section>
      </article>

      <section class="posts-nav content-grid">
        <span class="prev-post">
            <span
              ><a href="/blog.lmorchard.com/2016/11/11/heartbroken/"
                >Heartbroken</a
              ></span
            >
            <span
              ><span class="fa fa-long-arrow-left"></span>&nbsp;Previous</span
            >
          </span>
        <span class="next-post">
            <span
              ><a href="/blog.lmorchard.com/2016/09/11/poke-the-mongo/"
                >Poking the Mongo on Pico-8</a
              ></span
            >
            <span>Next&nbsp;<span class="fa fa-long-arrow-right"></span></span>
          </span>
      </section></section>

        <footer class="content-grid">
          <div class="left">
            © 2024 Les Orchard &lt;<a href="mailto:me@lmorchard.com"
              >me@lmorchard.com</a
            >&gt;
          </div>
          <img id="growup" src="/blog.lmorchard.com/uploads/growup.jpg" />
          <nav class="right">
            <ul>
              <li>
                <a href="https://lmorchard.github.io/blog.lmorchard.com/index.rss" title="blog.lmorchard.com"
                  ><span class="fa fa-rss"></span> feed</a
                >
              </li>
            </ul>
          </nav>
        </footer>
      </body>
    </html>