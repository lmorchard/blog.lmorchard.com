{"comments_archived":true,"date":"2004-08-23T00:00:00.000Z","excerpt":"I've been putting more work into dbagg3, but I'm getting hung up\non the database.  Well, actually I'm getting hung up on the subject\nof XML storage, query, and retrieval in general-- but at present, I'm\ntrying to cram all this data into MySQL and SQLite databases.  But,\nmy tendencies as an abstraction astronaut and my lack of database savvy\nare tying me (and my data) in knots.  I kept meaning to write a bit\nAtom (and XML in general) with regard to database storage and query,\nso maybe now's the time.","layout":"post","tags":["syndication","xml"],"title":"Slicing and Dicing to Make Atom Soup in dbagg3","wordpress_id":539,"wordpress_slug":"slicing-and-dicing-to-make-atom-soup-in-dbagg3","wordpress_url":"http://www.decafbad.com/blog/?p=539","url":"/2004/08/23/slicing-and-dicing-to-make-atom-soup-in-dbagg3/","path":"2004/08/23/slicing-and-dicing-to-make-atom-soup-in-dbagg3","content":"<p>I&#39;ve been putting more work into <a href=\"http://www.decafbad.com/cvs/dbagg3/\"><code>dbagg3</code></a>, but I&#39;m getting hung up on the database.  Well, actually I&#39;m getting hung up on the subject of XML storage, query, and retrieval in general-- but at present, I&#39;m trying to cram all this data into MySQL and SQLite databases.  But, my tendencies as an abstraction astronaut and my lack of database savvy are tying me (and my data) in knots.  I kept meaning to write a bit Atom (and XML in general) with regard to database storage and query, so maybe now&#39;s the time.</p>\n<h3 id=\"xml-databases\">XML databases</h3>\n<p>I&#39;m aware of XML-native databases like <a href=\"http://exist.sourceforge.net/\">eXist</a>, <a href=\"http://xml.apache.org/xindice/\">Xindice</a>, and <a href=\"http://www.sleepycat.com/products/xml.shtml\">Berkeley DB XML</a>-- but I don&#39;t want to work in Java right now, and I can&#39;t get the Berkeley XML DB compiled and running without segfault under OS X.  This bugs me, though, since the most elegant solution to me is to use something XML-native to store and query piles of Atom feeds and entries.  I&#39;d really like to have <a href=\"http://webservices.xml.com/pub/a/ws/2003/04/15/semanticblog.html\">XPath available as a query tool</a>.  And then, though I haven&#39;t heard a ton about it lately, there&#39;s XQuery.</p>\n<p>And, oh yeah, I know there are some commercial solutions (like <a href=\"http://virtuoso.openlinksw.com/\">Virtuoso</a>), but umm... no.</p>\n<h3 id=\"rdf-databases\">RDF databases</h3>\n<p>I suppose I could also switch to tossing RDF around internally, maybe use RSS 1.0 under the hood.  This seems to be what the much-similar <a href=\"http://urchin.sourceforge.net/\">Urchin RSS aggregator</a> is doing.  (Maybe I should just dump <code>dbagg3</code> and pitch in with Urchin.)  But, I don&#39;t know the state of RDF art well enough to know whether there&#39;s a database available that can handle 10,000 Atom/RSS entries a week or more for a year without gagging.  (My previous database was up to 500,000 entries when I started working on <code>dbagg3</code>, and I think that was since last November.)</p>\n<h3 id=\"sql-databases\">SQL databases</h3>\n<p>So, I&#39;m screwing around with SQL databases-- MySQL and SQLite in particular.  As compared to XML and RDF databases, I know and understand and trust SQL databases so much more with regards to performance and gotchas and general techniques.  </p>\n<p>In previous incarnations of my aggregator, MySQL and SQLite served me well with pretty simple data models.  But this time around, I want to play with much richer data: I want to include everything in the Atom spec, and try to take in some metadata from extensions.  So I threw together what I thought was a pretty decent relational model onto which I could map Atom XML data.  (If you&#39;re curious, you can check out <a href=\"http://www.decafbad.com/2004/08/dbagg3.sql\">a recent schema dump</a>.)</p>\n<p>The problem is, with the XML sliced and diced and sprinkled into all these separate tables, it&#39;s a <strong>fun</strong> time reassembling the pieces.  I&#39;ve run into this problem many times before, when trying to map object hierarchies into relational databases, and usually things degrade into nasty self-joins and an explosive number of queries.  This kind of inelegance smells really bad, oily like melting plastic caused by the friction of a square peg being driven into a round hole by my forehead as a hammer.</p>\n<p>In the end, what I&#39;ve usually ended up doing is to forget about mapping from objects to the relational model: tables become a set of indices to objects, the objects themselves packed up as BLOBs via some language-dependant pickling or freezing scheme.  Nasty, ugly, fragile, and completely inelegant.  There&#39;s some of that in <code>dbagg3</code> <em>right now</em>, and I want it out.  Though I used to think it was as clever and neat as a digital watch, this smells even worse than melting plastic.</p>\n<h3 id=\"xml-in-sql-databases\">XML in SQL databases</h3>\n<p>My latest thoughts, then, are to accept some bad smells (I <em>do</em> like the smell of burning plastic, actually) and simplify my database:  Instead of pickled binary objects, I&#39;ll store XML in a column (at least that isn&#39;t implementation-tied), and other tables will give me indices to this XML.  Thinking hard about my use cases, I think I can cover 80% of what I need with being able to look things up by feed, by subscription, by user, by date, and a few other useful aspects.  Once I&#39;ve gotten a pile of data out of the database in XML form, I can then attack it with XSL.</p>\n<p>However, what gives me even further enthusiasm for this approach is <a href=\"http://www.throwingbeans.org/tech/postgresql_and_xml.html\">this little XPath extension to PostgreSQL</a>.  This gives you a set of functions to apply XPath to XML-containing columns in SQL queries.  So, you can pull out nodes in a select, or search on the results in a WHERE clause, among other things.  I haven&#39;t tried it yet, but it gives me ideas.</p>\n<p>One idea is that, through <a href=\"http://pysqlite.sourceforge.net/old/documentation/pysqlite/node10.html\">PySQLite&#39;s API additions</a>, I can easily add new SQL functions at will-- oh like, say, some XPath functions using libxml2 under python.</p>\n<p>Granted, there are no indices backing these XPath searches, and using these python functions added to SQLite comes with overhead, the availability of XPath in SQL could give me the 20% I&#39;m missing with simple tables.  It might be worth the price and the smells.</p>\n<h3 id=\"so-anyway-\">So Anyway...</h3>\n<p>That&#39;s where I&#39;m at right now.  I think I&#39;ve written a bunch, and all this text could use some code examples and some diagrams.  But, I figured I&#39;d think out loud a bit and see if anyone could step in and smack me for being a complete twink.  </p>\n<p>I want to slurp in Atom XML data, with arbitrary extensions, and be able to attack it with some reasonable set of queries to recombine this data into new feeds.</p>\n<p>I know I&#39;m not the only person thinking about this stuff, and I&#39;ve got to assume that I&#39;m nowhere near the smartest about it.  I&#39;m still working on this aggregator thing, and making what I think is some fun progress with a <a href=\"http://www.decafbad.com/cvs/*checkout*/dbagg3/lib/dbagg3/web/api.py?rev=HEAD&#38;content-type=text/x-python\">REST interface</a>, but this data stuff has me stalled.</p>\n<p>So... what do you think?</p>\n<div id=\"comments\" class=\"comments archived-comments\">\n            <h3>Archived Comments</h3>\n\n        <ul class=\"comments\">\n\n        <li class=\"comment\" id=\"comment-221082837\">\n            <div class=\"meta\">\n                <div class=\"author\">\n                    <a class=\"avatar image\" rel=\"nofollow\" \n                       href=\"http://franklinmint.fm\"><img src=\"http://www.gravatar.com/avatar.php?gravatar_id=b9ed774661a22ff8797a1e0e24f0baf3&amp;size=32&amp;default=http://mediacdn.disqus.com/1320279820/images/noavatar32.png\"/></a>\n                    <a class=\"avatar name\" rel=\"nofollow\" \n                       href=\"http://franklinmint.fm\">Robert Sayre</a>\n                </div>\n                <a href=\"#comment-221082837\" class=\"permalink\"><time datetime=\"2004-08-23T19:23:19\">2004-08-23T19:23:19</time></a>\n            </div>\n            <div class=\"content\">FYI: Apple&#39;s upcoming SafariRSS uses XQuery to parse feeds. The Tiger version of NSXML includes XQuery as well.</div>\n\n<pre><code>    &lt;/li&gt;\n\n    &lt;li class=&quot;comment&quot; id=&quot;comment-221082838&quot;&gt;\n        &lt;div class=&quot;meta&quot;&gt;\n            &lt;div class=&quot;author&quot;&gt;\n                &lt;a class=&quot;avatar image&quot; rel=&quot;nofollow&quot; \n                   href=&quot;&quot;&gt;&lt;img src=&quot;http://www.gravatar.com/avatar.php?gravatar_id=719ad7cfa24c00bbcaa8030427dd8743&amp;amp;size=32&amp;amp;default=http://mediacdn.disqus.com/1320279820/images/noavatar32.png&quot;/&gt;&lt;/a&gt;\n                &lt;a class=&quot;avatar name&quot; rel=&quot;nofollow&quot; \n                   href=&quot;&quot;&gt;bear&lt;/a&gt;\n            &lt;/div&gt;\n            &lt;a href=&quot;#comment-221082838&quot; class=&quot;permalink&quot;&gt;&lt;time datetime=&quot;2004-08-23T21:16:42&quot;&gt;2004-08-23T21:16:42&lt;/time&gt;&lt;/a&gt;\n        &lt;/div&gt;\n        &lt;div class=&quot;content&quot;&gt;Not knowing what errors you are getting during the dbxml build means my comment will be generic but I hope it is still useful.\n</code></pre><p>The OSAF people are using dbxml as their back-end data store and their build process works on os/x (what I use) - I can forward the makefile or just compare notes if that is useful to you.</p>\n<p>thanks for your great writing</div></p>\n<pre><code>    &lt;/li&gt;\n\n    &lt;li class=&quot;comment&quot; id=&quot;comment-221082839&quot;&gt;\n        &lt;div class=&quot;meta&quot;&gt;\n            &lt;div class=&quot;author&quot;&gt;\n                &lt;a class=&quot;avatar image&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://randomthoughts.vandorp.ca/WK/blog&quot;&gt;&lt;img src=&quot;http://www.gravatar.com/avatar.php?gravatar_id=0a9028b800da9db6932c2f026d50847b&amp;amp;size=32&amp;amp;default=http://mediacdn.disqus.com/1320279820/images/noavatar32.png&quot;/&gt;&lt;/a&gt;\n                &lt;a class=&quot;avatar name&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://randomthoughts.vandorp.ca/WK/blog&quot;&gt;Darryl&lt;/a&gt;\n            &lt;/div&gt;\n            &lt;a href=&quot;#comment-221082839&quot; class=&quot;permalink&quot;&gt;&lt;time datetime=&quot;2004-08-24T04:27:51&quot;&gt;2004-08-24T04:27:51&lt;/time&gt;&lt;/a&gt;\n        &lt;/div&gt;\n        &lt;div class=&quot;content&quot;&gt;Try a recipe by Kimbro Staken \n</code></pre><p><a href=\"http://www.xmldatabases.org/movabletype/archives/000267.html\">http://www.xmldatabases.org/movabletype/archives/000267.html</a></div></p>\n<pre><code>    &lt;/li&gt;\n\n    &lt;li class=&quot;comment&quot; id=&quot;comment-221082840&quot;&gt;\n        &lt;div class=&quot;meta&quot;&gt;\n            &lt;div class=&quot;author&quot;&gt;\n                &lt;a class=&quot;avatar image&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://simon.incutio.com/&quot;&gt;&lt;img src=&quot;http://www.gravatar.com/avatar.php?gravatar_id=02ecb4f56e961dd226352c4dd51eff26&amp;amp;size=32&amp;amp;default=http://mediacdn.disqus.com/1320279820/images/noavatar32.png&quot;/&gt;&lt;/a&gt;\n                &lt;a class=&quot;avatar name&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://simon.incutio.com/&quot;&gt;Simon Willison&lt;/a&gt;\n            &lt;/div&gt;\n            &lt;a href=&quot;#comment-221082840&quot; class=&quot;permalink&quot;&gt;&lt;time datetime=&quot;2004-08-24T18:27:33&quot;&gt;2004-08-24T18:27:33&lt;/time&gt;&lt;/a&gt;\n        &lt;/div&gt;\n        &lt;div class=&quot;content&quot;&gt;Unfortunately, the XPath extension for PostgreSQL seems to be vapourware. As far as I know it exists only as a mention in the blog entry you linked to - the guy never released it. I&#39;d love to be proved wrong - I&#39;d really like to use it for a whole bunch of different things.&lt;/div&gt;\n\n    &lt;/li&gt;\n\n    &lt;li class=&quot;comment&quot; id=&quot;comment-221082841&quot;&gt;\n        &lt;div class=&quot;meta&quot;&gt;\n            &lt;div class=&quot;author&quot;&gt;\n                &lt;a class=&quot;avatar image&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://www.throwingbeans.org&quot;&gt;&lt;img src=&quot;http://www.gravatar.com/avatar.php?gravatar_id=96bc90c98bc78316eda53f6d1dbfa0f6&amp;amp;size=32&amp;amp;default=http://mediacdn.disqus.com/1320279820/images/noavatar32.png&quot;/&gt;&lt;/a&gt;\n                &lt;a class=&quot;avatar name&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://www.throwingbeans.org&quot;&gt;Tom Dyson&lt;/a&gt;\n            &lt;/div&gt;\n            &lt;a href=&quot;#comment-221082841&quot; class=&quot;permalink&quot;&gt;&lt;time datetime=&quot;2004-08-25T21:10:17&quot;&gt;2004-08-25T21:10:17&lt;/time&gt;&lt;/a&gt;\n        &lt;/div&gt;\n        &lt;div class=&quot;content&quot;&gt;The XPath extensions for Postgres are certainly not vapourware: we&#39;re using them in a content management environment for several high-profile websites. The extensions are available as part of the Postgres 8 beta download, where you&#39;ll find them in source code form in the contrib/xml directory. If you need help installing the functions, let me know - we have compiled them successfully on Debian, RedHat, OS X and Windows.&lt;/div&gt;\n\n    &lt;/li&gt;\n\n    &lt;li class=&quot;comment&quot; id=&quot;comment-221082842&quot;&gt;\n        &lt;div class=&quot;meta&quot;&gt;\n            &lt;div class=&quot;author&quot;&gt;\n                &lt;a class=&quot;avatar image&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://dannyayers.com&quot;&gt;&lt;img src=&quot;http://www.gravatar.com/avatar.php?gravatar_id=7028f422ca6da0180de6c9d922a3228f&amp;amp;size=32&amp;amp;default=http://mediacdn.disqus.com/1320279820/images/noavatar32.png&quot;/&gt;&lt;/a&gt;\n                &lt;a class=&quot;avatar name&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://dannyayers.com&quot;&gt;Danny&lt;/a&gt;\n            &lt;/div&gt;\n            &lt;a href=&quot;#comment-221082842&quot; class=&quot;permalink&quot;&gt;&lt;time datetime=&quot;2004-09-08T22:03:05&quot;&gt;2004-09-08T22:03:05&lt;/time&gt;&lt;/a&gt;\n        &lt;/div&gt;\n        &lt;div class=&quot;content&quot;&gt;I&#39;ve not tried that kind of data size with RDF either, though am assured kit like Kowari can handle it.\n</code></pre><p>A possible compromise approach might be to use SQL storage directly for core syndication stuff, with RDF at the side. </p>\n<p>Vaguely relevant blogged stuff:</p>\n<p><a href=\"http://dannyayers.com/archives/2004/08/10/extending-the-capabilities-of-content-management-systems-with-rdf/\">http://dannyayers.com/archives/2004/08/10/extending-the-capabilities-of-content-management-systems-with-rdf/</a></p>\n<p>another possibility is using a triplestore on top of SQL, you end up with views/queries like this:</p>\n<p><a href=\"http://dannyayers.com/archives/2004/07/14/all-in-a-days-work/\">http://dannyayers.com/archives/2004/07/14/all-in-a-days-work/</a></div></p>\n<pre><code>    &lt;/li&gt;\n\n    &lt;li class=&quot;comment&quot; id=&quot;comment-221082843&quot;&gt;\n        &lt;div class=&quot;meta&quot;&gt;\n            &lt;div class=&quot;author&quot;&gt;\n                &lt;a class=&quot;avatar image&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://netapps.muohio.edu/blogs/darcusb/darcusb/&quot;&gt;&lt;img src=&quot;http://www.gravatar.com/avatar.php?gravatar_id=8043a49e7e80eef7672fa2be09b51473&amp;amp;size=32&amp;amp;default=http://mediacdn.disqus.com/1320279820/images/noavatar32.png&quot;/&gt;&lt;/a&gt;\n                &lt;a class=&quot;avatar name&quot; rel=&quot;nofollow&quot; \n                   href=&quot;http://netapps.muohio.edu/blogs/darcusb/darcusb/&quot;&gt;Bruce&lt;/a&gt;\n            &lt;/div&gt;\n            &lt;a href=&quot;#comment-221082843&quot; class=&quot;permalink&quot;&gt;&lt;time datetime=&quot;2005-02-24T03:16:48&quot;&gt;2005-02-24T03:16:48&lt;/time&gt;&lt;/a&gt;\n        &lt;/div&gt;\n        &lt;div class=&quot;content&quot;&gt;You might take a look at BDB XML again.  I recall having problems compiling v1 on Mac OS X too, but had no such problems with v2.  And it addds XQuery to the mix.&lt;/div&gt;\n\n    &lt;/li&gt;\n\n    &lt;/ul&gt;\n\n    &lt;/div&gt;\n</code></pre>"}